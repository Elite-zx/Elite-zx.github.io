<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Stanford CS144 Spring 2023 | ELITE-X's blog</title><meta name="author" content="Elite-X"><meta name="copyright" content="Elite-X"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1.  lab0 networking warmup  1.1. Set up GNU&#x2F;Linux on your computer ubuntu22.04LTS下执行 sudo apt update &amp;&amp; sudo apt install git cmake gdb build-essential clang \ clang-tidy clang-format gcc-doc">
<meta property="og:type" content="article">
<meta property="og:title" content="Stanford CS144 Spring 2023">
<meta property="og:url" content="https://elite-zx.github.io/2023/05/31/computer-Network/CS144/index.html">
<meta property="og:site_name" content="ELITE-X&#39;s blog">
<meta property="og:description" content="1.  lab0 networking warmup  1.1. Set up GNU&#x2F;Linux on your computer ubuntu22.04LTS下执行 sudo apt update &amp;&amp; sudo apt install git cmake gdb build-essential clang \ clang-tidy clang-format gcc-doc">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://elite-zx.github.io/img/cat.jpg">
<meta property="article:published_time" content="2023-05-30T16:00:00.000Z">
<meta property="article:modified_time" content="2023-06-05T09:18:47.690Z">
<meta property="article:author" content="Elite-X">
<meta property="article:tag" content="Foundation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://elite-zx.github.io/img/cat.jpg"><link rel="shortcut icon" href="/img/linux.ico"><link rel="canonical" href="https://elite-zx.github.io/2023/05/31/computer-Network/CS144/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="0V6rot-q_o_MYoihQQBB9P3yjYfncWGfFpAD6Ejlv84"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://unpkg.com/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://unpkg.com/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Stanford CS144 Spring 2023',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-05 17:18:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/bg.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/xlenco/JS-X@main/pace.js/pace.css"/><script src="https://unpkg.com/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/cat.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="ELITE-X's blog"><span class="site-name">ELITE-X's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Stanford CS144 Spring 2023</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-05-30T16:00:00.000Z" title="Created 2023-05-31 00:00:00">2023-05-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-06-05T09:18:47.690Z" title="Updated 2023-06-05 17:18:47">2023-06-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Computer-Network/">Computer Network</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Stanford CS144 Spring 2023"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="1-lab0-networking-warmup"><a class="markdownIt-Anchor" href="#1-lab0-networking-warmup"></a> 1.  lab0 networking warmup</h1>
<h2 id="11-set-up-gnulinux-on-your-computer"><a class="markdownIt-Anchor" href="#11-set-up-gnulinux-on-your-computer"></a> 1.1. Set up GNU/Linux on your computer</h2>
<p>ubuntu22.04LTS下执行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">git</span> cmake gdb build-essential clang <span class="token punctuation">\</span>
clang-tidy clang-format gcc-doc pkg-config glibc-doc tcpdump tshark<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>安装g++12.3.0</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> add-apt-repository ppa:ubuntu-toolchain-r/ppa
<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> g++-12 <span class="token parameter variable">-y</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<img src="/2023/05/31/computer-Network/CS144/d6f4cf3e9c0ddf6dfec8cf56cdbf46a7.png" class="">
<p>将minnow仓库上传到自己的仓库，参考<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10065526/github-how-to-make-a-fork-of-public-repository-private">这个方法</a><br />
如果你做的是2023年之前的版本，需要用到sponge仓库，那么我<a target="_blank" rel="noopener" href="https://github.com/Elite-zx/CS144-sponge">这里</a>有一份未被修改过的版本</p>
<h2 id="12-networking-by-hand"><a class="markdownIt-Anchor" href="#12-networking-by-hand"></a> 1.2. Networking by hand</h2>
<h3 id="121-fetch-a-web-page"><a class="markdownIt-Anchor" href="#121-fetch-a-web-page"></a> 1.2.1. Fetch a Web page</h3>
<p>先提前准备好这3行首部信息，连接成功后快速复制进去，避免连接断开(<code>Connection closed by foreign host.</code>)</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/hello</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">cs144.keithw.org</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<img src="/2023/05/31/computer-Network/CS144/c115d6890f5fd5aa7520dc617a5b121e.png" class="">
<p>(Pretend to be a student at Stanford✌️)</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/lab0/elitezx</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">cs144.keithw.org</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<img src="/2023/05/31/computer-Network/CS144/dfd50d27a92f6fa60d1b2f2a923902a8.png" class="">
<h3 id="122-send-yourself-an-email"><a class="markdownIt-Anchor" href="#122-send-yourself-an-email"></a> 1.2.2. Send yourself an email</h3>
<p>这个实现在 <em>自顶向下</em> 的实验中已经完成过了，就不再重复了</p>
<img src="/2023/05/31/computer-Network/CS144/d23d0311f3b4833f4d77f9aba232d1a2.png" class="">
<h3 id="123-listening-and-connecting"><a class="markdownIt-Anchor" href="#123-listening-and-connecting"></a> 1.2.3. Listening and connecting</h3>
<p>netcat监听一个端口， telnet 连接到一个端口使用telnet连接到一个端口，该端口必须处于监听状态</p>
<img src="/2023/05/31/computer-Network/CS144/254604b0f9b24b1052e329f52117eb1f.png" class="">
<img src="/2023/05/31/computer-Network/CS144/6da45053969b61df7a75cfb36704fc13.png" class="">
<h2 id="13-writing-a-network-program-using-an-os-stream-socket"><a class="markdownIt-Anchor" href="#13-writing-a-network-program-using-an-os-stream-socket"></a> 1.3. Writing a network program using an OS stream socket</h2>
<h3 id="131-lets-get-startedfetching-and-building-the-starter-code"><a class="markdownIt-Anchor" href="#131-lets-get-startedfetching-and-building-the-starter-code"></a> 1.3.1. Let’s get started—fetching and building the starter code</h3>
<p>安装最新版的cmake，ubuntu22.04  follow <a target="_blank" rel="noopener" href="https://askubuntu.com/a/1157132/1681772">here</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> minnow
cmake <span class="token parameter variable">-S</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-B</span> build
cmake <span class="token parameter variable">--build</span> build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<img src="/2023/05/31/computer-Network/CS144/bc74865004fa7f18defa1fe09d61f59f.png" class="">
<h3 id="132-modern-c-mostly-safe-but-still-fast-and-low-level"><a class="markdownIt-Anchor" href="#132-modern-c-mostly-safe-but-still-fast-and-low-level"></a> 1.3.2. Modern C++: mostly safe but still fast and low-level</h3>
<p>代码规范</p>
<h3 id="133-reading-the-minnow-support-code"><a class="markdownIt-Anchor" href="#133-reading-the-minnow-support-code"></a> 1.3.3. Reading the Minnow support code</h3>
<p>Adress</p>
<img src="/2023/05/31/computer-Network/CS144/7f7a17c918370d5a53fff8f0624c401c.png" class="">
<p>file_descriptor</p>
<img src="/2023/05/31/computer-Network/CS144/399585efdc594c98c39eee207e8cb94f.png" class="">
<p>socket</p>
<img src="/2023/05/31/computer-Network/CS144/a9b1e0847665ded2b05c50e9ede31e7d.png" class="">
<p>TCPSocket</p>
<img src="/2023/05/31/computer-Network/CS144/51aa482e91ac4069a40b0a3ef6a6f84d.png" class="">
<h3 id="134-writing-webget"><a class="markdownIt-Anchor" href="#134-writing-webget"></a> 1.3.4. Writing webget</h3>
<p>根据提供的类，可以很轻松的写出来（10行够了，但完整和规范）。注意write接受string_view的对象，但是该类不能使用’+'运算符，因此用string代替。string_view和string的区别在于string_view只能被访问而不能被修改( refer to a constant contiguous sequence),，而string可以追加、删除和修改字符</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">get_URL</span><span class="token punctuation">(</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> host<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> path <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// cerr &lt;&lt; "Function called: get_URL(" &lt;&lt; host &lt;&lt; ", " &lt;&lt; path &lt;&lt; ")\n";</span>
  <span class="token comment">// cerr &lt;&lt; "Warning: get_URL() has not been implemented yet.\n";</span>
  TCPSocket tcp_socket <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Address <span class="token function">target_addr</span><span class="token punctuation">(</span> host<span class="token punctuation">,</span> <span class="token string">"http"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcp_socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span> target_addr <span class="token punctuation">)</span><span class="token punctuation">;</span>
  string request <span class="token punctuation">&#123;</span> <span class="token string">"GET "</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">" HTTP/1.1\r\n"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// can not use '+' in string_view object</span>
  cout <span class="token operator">&lt;&lt;</span> request<span class="token punctuation">;</span>
  string header0 <span class="token punctuation">&#123;</span> <span class="token string">"Host: "</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">"\r\n"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  cout <span class="token operator">&lt;&lt;</span> header0<span class="token punctuation">;</span>
  string_view header1 <span class="token punctuation">&#123;</span> <span class="token string">"Connection: close\r\n"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  cout <span class="token operator">&lt;&lt;</span> header1<span class="token punctuation">;</span>
  string_view empty_line <span class="token punctuation">&#123;</span> <span class="token string">"\r\n"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  cout <span class="token operator">&lt;&lt;</span> empty_line<span class="token punctuation">;</span>
  tcp_socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span> request <span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcp_socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span> header0 <span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcp_socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span> header1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcp_socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span> empty_line <span class="token punctuation">)</span><span class="token punctuation">;</span>
  string rcv_buffer<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>tcp_socket<span class="token punctuation">.</span><span class="token function">eof</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    tcp_socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span> rcv_buffer <span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> rcv_buffer<span class="token punctuation">;</span>
    rcv_buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  tcp_socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// destructor</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./apps/webget cs144.keithw.org /hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<img src="/2023/05/31/computer-Network/CS144/87b796b15c232a403d24ed3180cd473e.png" class="">
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cmake <span class="token parameter variable">--build</span> build <span class="token parameter variable">--target</span> check_webget<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<img src="/2023/05/31/computer-Network/CS144/70352ffb130b6bf7fbd2bad02b119435.png" class="">
<h2 id="14-an-in-memory-reliable-byte-stream"><a class="markdownIt-Anchor" href="#14-an-in-memory-reliable-byte-stream"></a> 1.4. An in-memory reliable byte stream</h2>
<h3 id="141-target"><a class="markdownIt-Anchor" href="#141-target"></a> 1.4.1. target</h3>
<p>在 “An in-memory reliable byte stream” 这一小节中，文档要求你<strong>实现一个可靠的字节流</strong>。这个字节流需要满足以下几个条件：</p>
<ul>
<li>字节流是有限的：写入者可以结束输入，然后就不能再写入更多的字节。当读取者读到流的末尾时，它将到达“EOF”（文件结束），并且不能再读取更多的字节。</li>
<li>字节流也需要进行流量控制，以限制其在任何给定时间的内存消耗。对象在初始化时会有一个特定的_capacity：它在任何给定点愿意在自己的内存中存储的最大字节数。字节流将限制写入者在任何给定时刻可以写入的量，以确保流不会超过其存储容量。当读取者读取字节并从流中排出它们时，写入者被允许写入更多。</li>
<li>字节流的使用是在单线程中，你不需要担心并发的写入者/读取者、锁定或竞争条件。</li>
</ul>
<p>你需要实现以下的接口：<br />
对于写入者：</p>
<ul>
<li>void push( std::string data ); // 将数据推送到流中，但只能推送可用容量允许的量。</li>
<li>void close(); // 表示流已经结束。不会再有更多的写入。</li>
<li>void set_error(); // 表示流出现了错误。</li>
<li>bool is_closed() const; // 流是否已经关闭？</li>
<li>uint64_t available_capacity() const; // 现在可以推送到流中的字节数是多少？</li>
<li>uint64_t bytes_pushed() const; // 累计推送到流中的总字节数。</li>
</ul>
<p>对于读取者：</p>
<ul>
<li>std::string_view peek() const; // 查看缓冲区中的下一个字节</li>
<li>void pop( uint64_t len ); // 从缓冲区中移除 <code>len</code> 个字节</li>
<li>bool is_finished() const; // 流是否已经结束（已关闭并完全弹出）？</li>
<li>bool has_error() const; // 流是否出现过错误？</li>
<li>uint64_t bytes_buffered() const; // 当前缓冲的字节数（已推送但未弹出）</li>
<li>uint64_t bytes_popped() const; // 累计从流中弹出的总字节数。</li>
</ul>
<p>你需要打开 src/byte_stream.hh 和 src/byte_stream.cc 文件，并实现提供这个接口的对象。在你开发字节流实现的过程中，你可以使用 cmake --build build --target check0 运行自动化测试。如果所有测试都通过，check0 测试将会运行你的实现的速度基准测试。</p>
<h3 id="142-source-code"><a class="markdownIt-Anchor" href="#142-source-code"></a> 1.4.2. source code</h3>
<p>byte_stream.hh</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">ByteStream</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
  <span class="token keyword">uint64_t</span> capacity_<span class="token punctuation">;</span>
  <span class="token comment">// Please add any additional state to the ByteStream here, and not to the Writer and Reader interfaces.</span>
  std<span class="token double-colon punctuation">::</span>deque<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> mem_buf<span class="token punctuation">;</span>
  size_t bytes_pushed_cnt<span class="token punctuation">;</span>
  size_t bytes_poped_cnt<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> is_end<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> is_err<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>byte_stream.cc</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token class-name">ByteStream</span><span class="token double-colon punctuation">::</span><span class="token function">ByteStream</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> capacity <span class="token punctuation">)</span>
  <span class="token operator">:</span> capacity_ <span class="token punctuation">&#123;</span> capacity <span class="token punctuation">&#125;</span>
  <span class="token punctuation">,</span> mem_buf <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">,</span> bytes_pushed_cnt <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">,</span> bytes_poped_cnt <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">,</span> is_end <span class="token punctuation">&#123;</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">,</span> is_err <span class="token punctuation">&#123;</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">push</span><span class="token punctuation">(</span> string data <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  size_t allowed_size <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  allowed_size <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span> data<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> capacity_ <span class="token operator">-</span> mem_buf<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// flow-controlled</span>
  data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> allowed_size <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">&amp;</span> c <span class="token operator">:</span> data <span class="token punctuation">)</span>
    mem_buf<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>
  bytes_pushed_cnt <span class="token operator">+=</span> allowed_size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  is_end <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">set_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  is_err <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">bool</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token keyword">return</span> is_end<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">uint64_t</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token keyword">return</span> capacity_ <span class="token operator">-</span> mem_buf<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">uint64_t</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token keyword">return</span> bytes_pushed_cnt<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

string_view <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token keyword">return</span> string_view <span class="token punctuation">&#123;</span> <span class="token operator">&amp;</span>mem_buf<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// const char*</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">bool</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">is_finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token keyword">return</span> is_end <span class="token operator">&amp;&amp;</span> mem_buf<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">bool</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">has_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token keyword">return</span> is_err<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">pop</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> len <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  len <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span> len<span class="token punctuation">,</span> mem_buf<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// avoid illegal len</span>
  <span class="token keyword">int</span> _size <span class="token operator">=</span> len<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> _size<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
    mem_buf<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bytes_poped_cnt <span class="token operator">+=</span> len<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">uint64_t</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token keyword">return</span> mem_buf<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">uint64_t</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_popped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token keyword">return</span> bytes_poped_cnt<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="143-result"><a class="markdownIt-Anchor" href="#143-result"></a> 1.4.3. result</h3>
<img src="/2023/05/31/computer-Network/CS144/a8993a0ccdbc79fc8603e6126bdda791.png" class=""> 
<h1 id="2-lab1-stitching-substrings-into-a-byte-stream"><a class="markdownIt-Anchor" href="#2-lab1-stitching-substrings-into-a-byte-stream"></a> 2. lab1 stitching substrings into a byte stream</h1>
<h2 id="21-target"><a class="markdownIt-Anchor" href="#21-target"></a> 2.1. target</h2>
<p>将远程仓库的 <code>check1-startercode</code> 分支的更改合并到当前所在的main分支，重新cmake</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> merge origin/check1-startercode
cmake <span class="token parameter variable">-S</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-B</span> build
cmake <span class="token parameter variable">--build</span> build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在这个实验和下一个实验中，你将实现一个TCP接收器：这个模块接收数据报，并将它们转换成一个可靠的字节流，以便应用程序从套接字中读取——就像你在Checkpoint 0中的webget程序从webserver中读取字节流一样。</p>
<p>TCP发送器将其字节流分割成短的段（子字符串，每个不超过约1460字节），以便它们每个都能装入一个数据报。但是，网络可能会重新排序这些数据报，或者丢弃它们，或者多次传送它们。接收器必须将这些段重新组装成它们开始时的连续字节流。</p>
<p>在这个实验中，你将编写一个负责这种重组的数据结构：<strong>一个Reassembler</strong>。它将接收子字符串，由一串字节和该字符串在更大流中的第一个字节的索引组成。流的每一个字节都有它自己的唯一索引，从零开始并向上计数。</p>
<img src="/2023/05/31/computer-Network/CS144/b93603f9efe81d5ff6627cb41ccc715c.png" class="">
<h2 id="22-analyze"><a class="markdownIt-Anchor" href="#22-analyze"></a> 2.2. analyze</h2>
<img src="/2023/05/31/computer-Network/CS144/b9d0adf15b770596e7b145e3d3f2df50.png" class="">
<p>首先理解内存限制的要求。ByteStream对象的capacity分为了两个部分，一个是用于字节流的buffer，用于存储重组好的有序字节流，这是对writer对象和reader对象而言的。一个是用于未重组的字节流的缓冲，可通过available_capacity()方法获取，这是reassembler对象而言的。因为capacity是固定的，意味着如果pop的频率太小，那么capacity被有序字节流填满，此时重组器reassembler会停止工作，因为它的存储空间available_capacity为0。</p>
<p>其次，实现这个reassembler最大的难点在于：如何<strong>处理重叠的子串</strong>。比如first_unassemble_index(期望接受的第一个有序字节)是’a’，但是先后来了子串’bc’，‘c’，这两个子串就要缓存在reassembler的内存空间中(大小为available capacity, 如果该值大于2的话)。我们需要在将c加入子串的时候，执行remove_overlapping操作，将这两个重叠子串合并为’bc’，这样确保reassembler中缓存空间中不存在重叠子串。换句话说，就是在新的子串要缓存时，在加入前先与缓存中重叠的子串执行合并操作，以确保加入后缓存中不存在重复子串，合并后bytes_pending（<code>unordered_bytes_size</code>）减去相应子串的大小。这样的目的是节省内存空间，并且在期望的有序字节达到<code>last_index + 1 == begin_index</code>时，也能快速的与缓存中的相邻子串合并然后通过writer的push函数push到reader的buffer中。</p>
<p>不仅如此，我们对新来的子串，在合并操作前，我们还要<strong>确保该子串是合法的</strong>，即该子串是在first_unassembled_index（<code>output.bytes_pushed()</code>）和first_unacceptable_index-1（<code>output.bytes_pushed()+output.available_capacity() - 1</code>）之间的，也就是说该子串的字节即不是已经被pop的，也不是到了buffer中的，更不是capacity之外的(否则会超出容量)，这个可以通过判断边界值做到。</p>
<p>在选择数据结果的问题上，我一开始为了效率（<code>string next_substring = unordered_bytes_buffer[first_index]</code>更快一点），选择了unordered_map,但是后来在test阶段，发现遍历reassembler的缓存unordered_bytes_buffer时，必须按first_index从小到大遍历，否则合并操作会出现遗漏，而unordered_map无法指定遍历顺序，因为哈希值我是不知道的，于是换成了能自动根据key值排序(默认从小到大)的map</p>
<p>在判断是否Finish的问题上，除了要满足达到接受方的流is_last_substring为true，还要满足reassembler已经通过writer的push函数将所有有序字节push到了buffer中，即<code>output.bytes_pushed() = first_index + data.size()</code></p>
<p>完成这个实验是不容易的，说实话我看把文档看懂让我究竟干什么都花了1个小时，花了一上午写好初始代码，结果一开始只能通过8个test用例，调试了一下午，逐步通过cap,dup…。这期间加入了很多cout语句（很管用），因为我对gdb还不咋熟悉，而且这文件也太多了。 最后测试到win又报错了，这个时候分析打印结果不太可行了，于是我硬着头皮又重新过了一遍自己的代码，发现是合并操作计算边界时+1,-1问题，最后成功通过test！</p>
<h2 id="23-source-code"><a class="markdownIt-Anchor" href="#23-source-code"></a> 2.3. source code</h2>
<h3 id="231-reassemblerhh"><a class="markdownIt-Anchor" href="#231-reassemblerhh"></a> 2.3.1 reassembler.hh</h3>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Reassembler</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">private</span><span class="token operator">:</span>
  size_t next_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// the next ordered index,which will push to bytestream by writer</span>
  size_t unordered_bytes_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>map<span class="token operator">&lt;</span>size_t<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span> unordered_bytes_buffer <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// store unordered bytes</span>
  <span class="token keyword">bool</span> byte_stream_end <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  size_t eof_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// function:let string legal</span>
  <span class="token keyword">void</span> <span class="token function">process_substr</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span><span class="token operator">&amp;</span> first_index<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> data<span class="token punctuation">,</span> Writer<span class="token operator">&amp;</span> output <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// make sure no overlapping in reassembler buffer</span>
  <span class="token keyword">void</span> <span class="token function">remove_overlap</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span><span class="token operator">&amp;</span> first_index<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="232-reassemblercc"><a class="markdownIt-Anchor" href="#232-reassemblercc"></a> 2.3.2 <a target="_blank" rel="noopener" href="http://reassembler.cc">reassembler.cc</a></h3>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"reassembler.hh"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"byte_stream.hh"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iterator></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h></span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token class-name">Reassembler</span><span class="token double-colon punctuation">::</span><span class="token function">insert</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> first_index<span class="token punctuation">,</span> string data<span class="token punctuation">,</span> <span class="token keyword">bool</span> is_last_substring<span class="token punctuation">,</span> Writer<span class="token operator">&amp;</span> output <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token function">process_substr</span><span class="token punctuation">(</span> first_index<span class="token punctuation">,</span> data<span class="token punctuation">,</span> output <span class="token punctuation">)</span><span class="token punctuation">;</span>
  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"next_index: "</span> <span class="token operator">&lt;&lt;</span> next_index <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">==</span> next_index <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    string next_substring <span class="token operator">=</span> unordered_bytes_buffer<span class="token punctuation">[</span>first_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"push to buffer!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> next_substring <span class="token punctuation">)</span><span class="token punctuation">;</span>
    unordered_bytes_size <span class="token operator">-=</span> next_substring<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    unordered_bytes_buffer<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span> first_index <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// key_type</span>
  <span class="token punctuation">&#125;</span>
  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"unordered_bytes_size: "</span> <span class="token operator">&lt;&lt;</span> unordered_bytes_size <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> is_last_substring <span class="token punctuation">)</span> <span class="token comment">// all bytes arrived</span>
  <span class="token punctuation">&#123;</span>
    byte_stream_end <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    eof_index <span class="token operator">=</span> first_index <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> byte_stream_end <span class="token operator">&amp;&amp;</span> output<span class="token punctuation">.</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> eof_index <span class="token punctuation">)</span> <span class="token comment">// all bytes pushed</span>
  <span class="token punctuation">&#123;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"All done!"</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    output<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">Reassembler</span><span class="token double-colon punctuation">::</span><span class="token function">process_substr</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span><span class="token operator">&amp;</span> first_index<span class="token punctuation">,</span> string<span class="token operator">&amp;</span> data<span class="token punctuation">,</span> Writer<span class="token operator">&amp;</span> output <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/* within the stream’s available capacity():
   * [first_unassembled index,first unacceptable index]*/</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// empty input , will make last_index invalid (unsigned int -> -1 -> max int)</span>
  <span class="token punctuation">&#123;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"empty input!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  size_t begin_of_storage <span class="token operator">=</span> output<span class="token punctuation">.</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// first_unassembled index</span>
  size_t end_of_storage <span class="token operator">=</span> begin_of_storage <span class="token operator">+</span> output<span class="token punctuation">.</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// first unacceptable index -1</span>
  size_t last_index <span class="token operator">=</span> first_index <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  next_index <span class="token operator">=</span> begin_of_storage<span class="token punctuation">;</span>

  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"begin of storage: "</span> <span class="token operator">&lt;&lt;</span> begin_of_storage <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"end_of_storage: "</span> <span class="token operator">&lt;&lt;</span> end_of_storage <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"last_index: "</span> <span class="token operator">&lt;&lt;</span> last_index <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
  cout <span class="token operator">&lt;&lt;</span> <span class="token string">"first_index: "</span> <span class="token operator">&lt;&lt;</span> first_index <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> begin_of_storage <span class="token operator">></span> end_of_storage <span class="token punctuation">)</span> <span class="token comment">// buffer is full, waiting for ReadAll</span>
  <span class="token punctuation">&#123;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"buffer is full and storage of reassembler is empty!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">></span> end_of_storage <span class="token operator">||</span> last_index <span class="token operator">&lt;</span> begin_of_storage <span class="token punctuation">)</span> <span class="token comment">// out of range</span>
  <span class="token punctuation">&#123;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"index out of range!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">&lt;</span> begin_of_storage <span class="token operator">&amp;&amp;</span> last_index <span class="token operator">>=</span> begin_of_storage <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"keep tail!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span> begin_of_storage <span class="token operator">-</span> first_index <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// keep tail</span>
    first_index <span class="token operator">=</span> begin_of_storage<span class="token punctuation">;</span>                       <span class="token comment">// update first_index</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">>=</span> begin_of_storage <span class="token operator">&amp;&amp;</span> last_index <span class="token operator">></span> end_of_storage <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"keep head!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> end_of_storage <span class="token operator">-</span> first_index <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// keep head</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// cout &lt;&lt; "string process is done!" &lt;&lt; endl;</span>
  <span class="token comment">// cout &lt;&lt; data &lt;&lt; endl;</span>
  <span class="token function">remove_overlap</span><span class="token punctuation">(</span> first_index<span class="token punctuation">,</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// cout &lt;&lt; "is not  overlap error" &lt;&lt; endl;</span>
  unordered_bytes_buffer<span class="token punctuation">[</span>first_index<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
  unordered_bytes_size <span class="token operator">+=</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">Reassembler</span><span class="token double-colon punctuation">::</span><span class="token function">remove_overlap</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span><span class="token operator">&amp;</span> first_index<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> data <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>unordered_bytes_buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">auto</span> iter <span class="token operator">=</span> unordered_bytes_buffer<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter <span class="token operator">!=</span> unordered_bytes_buffer<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    size_t last_index <span class="token operator">=</span> first_index <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    size_t begin_index <span class="token operator">=</span> iter<span class="token operator">-></span>first<span class="token punctuation">;</span>
    size_t end_index <span class="token operator">=</span> iter<span class="token operator">-></span>first <span class="token operator">+</span> iter<span class="token operator">-></span>second<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"begin_index: "</span> <span class="token operator">&lt;&lt;</span> begin_index <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span>
         <span class="token operator">&lt;&lt;</span> <span class="token string">"end_index: "</span> <span class="token operator">&lt;&lt;</span> end_index <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"first_index: "</span> <span class="token operator">&lt;&lt;</span> first_index <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span>
         <span class="token operator">&lt;&lt;</span> <span class="token string">"last_index: "</span> <span class="token operator">&lt;&lt;</span> last_index <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> last_index <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> begin_index <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      cout <span class="token operator">&lt;&lt;</span> <span class="token string">"exactly append!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
      data <span class="token operator">+=</span> iter<span class="token operator">-></span>second<span class="token punctuation">;</span>
      unordered_bytes_size <span class="token operator">-=</span> iter<span class="token operator">-></span>second<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      iter <span class="token operator">=</span> unordered_bytes_buffer<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span> iter <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// not use erase(key), it will casue iterator invalid</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Overlap between head and tail.</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">&lt;=</span> begin_index <span class="token operator">&amp;&amp;</span> begin_index <span class="token operator">&lt;=</span> last_index <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// = reason : "bc" "b"</span>
      cout <span class="token operator">&lt;&lt;</span> <span class="token string">"append tail!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> end_index <span class="token operator">&lt;=</span> last_index <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// completely covered</span>
        unordered_bytes_size <span class="token operator">-=</span> unordered_bytes_buffer<span class="token punctuation">[</span>begin_index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iter <span class="token operator">=</span> unordered_bytes_buffer<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span> iter <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        data <span class="token operator">+=</span> iter<span class="token operator">-></span>second<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span> last_index <span class="token operator">-</span> begin_index <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        unordered_bytes_size <span class="token operator">-=</span> unordered_bytes_buffer<span class="token punctuation">[</span>begin_index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iter <span class="token operator">=</span> unordered_bytes_buffer<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span> iter <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> begin_index <span class="token operator">&lt;=</span> first_index <span class="token operator">&amp;&amp;</span> first_index <span class="token operator">&lt;=</span> end_index <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// = reason: "bc" "c"</span>
      cout <span class="token operator">&lt;&lt;</span> <span class="token string">"append head!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> last_index <span class="token operator">&lt;=</span> end_index <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        first_index <span class="token operator">=</span> begin_index<span class="token punctuation">;</span>
        data <span class="token operator">=</span> iter<span class="token operator">-></span>second<span class="token punctuation">;</span>
        unordered_bytes_size <span class="token operator">-=</span> iter<span class="token operator">-></span>second<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iter <span class="token operator">=</span> unordered_bytes_buffer<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span> iter <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        data <span class="token operator">=</span> iter<span class="token operator">-></span>second<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> first_index <span class="token operator">-</span> begin_index <span class="token punctuation">)</span> <span class="token operator">+</span> data<span class="token punctuation">;</span>
        unordered_bytes_size <span class="token operator">-=</span> iter<span class="token operator">-></span>second<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iter <span class="token operator">=</span> unordered_bytes_buffer<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span> iter <span class="token punctuation">)</span><span class="token punctuation">;</span>
        first_index <span class="token operator">=</span> begin_index<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token operator">++</span>iter<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"after removing overlapping---"</span>
         <span class="token operator">&lt;&lt;</span> <span class="token string">"first_index: "</span> <span class="token operator">&lt;&lt;</span> first_index <span class="token operator">&lt;&lt;</span> <span class="token string">" last_index: "</span> <span class="token operator">&lt;&lt;</span> first_index <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">uint64_t</span> <span class="token class-name">Reassembler</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_pending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token keyword">return</span> unordered_bytes_size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="24-result"><a class="markdownIt-Anchor" href="#24-result"></a> 2.4. result</h2>
<img src="/2023/05/31/computer-Network/CS144/61b17337a7d88a508fbce358e642c62e.png" class="">
<h1 id="3-lab2-the-tcp-receiver"><a class="markdownIt-Anchor" href="#3-lab2-the-tcp-receiver"></a> 3. lab2 the TCP receiver</h1>
<h2 id="31-translating-between-64-bit-indexes-and-32-bit-seqnos"><a class="markdownIt-Anchor" href="#31-translating-between-64-bit-indexes-and-32-bit-seqnos"></a> 3.1. Translating between 64-bit indexes and 32-bit seqnos</h2>
<img src="/2023/05/31/computer-Network/CS144/0c490d98cf317a4773f7a4451f66c0c0.png" class="">
<p>首先要解决的问题是，TCP有限的字节序列字段造成的有限字节序列范围进而导致的回绕问题，我们需要在永不会溢出的64位绝对序号和会发生回绕的32位相对序号之间实现转换，因为对重组器来说，字节流是从0开始的不会回绕的序列。此外，TCP随机的初始字节序号(ISN)为这个问题增加了难度</p>
<img src="/2023/05/31/computer-Network/CS144/9f709e9806e18ae85d29faacc9785481.png" class="">
<h3 id="311-wrapabsolute-seqno-to-seqno"><a class="markdownIt-Anchor" href="#311-wrapabsolute-seqno-to-seqno"></a> 3.1.1 wrap—absolute seqno to seqno</h3>
<p>把绝对序号转换为相对序号的wrap函数很简单，n的高32位表示绕了多少圈然后从0计数，带入这部分计算没有意义。因此截去n的高32位而将n的低32位与ISN相加即可得到目标相对序列（注释中有取余数的版本）</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Wrap32 <span class="token class-name">Wrap32</span><span class="token double-colon punctuation">::</span><span class="token function">wrap</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> n<span class="token punctuation">,</span> Wrap32 zero_point <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token comment">// return Wrap32 &#123; static_cast&lt;uint32_t>( ( n + zero_point.raw_value_ ) % ( 1ul &lt;&lt; 32 ) ) &#125;;</span>
  <span class="token keyword">return</span> zero_point <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> n <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="312-unwrap-seqno-to-absolute-seqno"><a class="markdownIt-Anchor" href="#312-unwrap-seqno-to-absolute-seqno"></a> 3.1.2 unwrap— seqno to absolute seqno</h3>
<p>这个函数给我干沉默了，我连别人的答案和解释都看不懂，说句惭愧的，我拿这玩意起码问了chatgpt几个小时，想了好几个小时，我都没整明白这个if语句是怎么来的，什么回绕之后ans要减去<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>，搞不懂。我说我在这个函数上磨了一天的时间都不夸张，还是理解不了，不管它了。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">uint64_t</span> <span class="token class-name">Wrap32</span><span class="token double-colon punctuation">::</span><span class="token function">unwrap</span><span class="token punctuation">(</span> Wrap32 zero_point<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> checkpoint <span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">uint64_t</span> uint32_range <span class="token operator">=</span> <span class="token number">1ul</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-></span>raw_value_ <span class="token operator">-</span> <span class="token function">wrap</span><span class="token punctuation">(</span> checkpoint<span class="token punctuation">,</span> zero_point <span class="token punctuation">)</span><span class="token punctuation">.</span>raw_value_<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> ans <span class="token operator">=</span> checkpoint <span class="token operator">+</span> offset<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> offset <span class="token operator">>=</span> <span class="token number">1ul</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span> <span class="token operator">&amp;&amp;</span> ans <span class="token operator">>=</span> uint32_range <span class="token punctuation">)</span> <span class="token comment">// ?</span>
    ans <span class="token operator">-=</span> uint32_range<span class="token punctuation">;</span>
  <span class="token keyword">return</span> ans<span class="token punctuation">;</span>
  <span class="token comment">// Your code here.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="32-implementing-the-tcp-receiver"><a class="markdownIt-Anchor" href="#32-implementing-the-tcp-receiver"></a> 3.2. Implementing the TCP receiver</h2>
<h3 id="321-receive"><a class="markdownIt-Anchor" href="#321-receive"></a> 3.2.1 receive</h3>
<p>对收到的message,首先要判断是否是SYN握手信息，并在收到此信息之后进入数据交换阶段（tcp连接已建立），因此要有一个bool变量<code>after_handshaking</code>标志现在是否处于三次握手之后的状态。在收到SYN后，因为SYN被置1的包的序号是发送端的随机初始序号ISN，因此将zero_point置为该值以便后续将相对序号<code>seqno</code>转变为绝对序号<code>absolute_seqno</code>。（为了声明和赋值zero_point成员变量，要在Wrap32类中添加指定的默认构造函数(= default)，复制构造函数和重载赋值运算符（这两个必须同时实现））</p>
<img src="/2023/05/31/computer-Network/CS144/9818e9d7cdd833e176a6dd96ca42a339.png" class="">
<p>因为重组器对收到的字节流，从0编号，因此传递给reassembler的first_index要去除SYN所占的序号(如果存在SYN)，用<code>first_index = absolute_seqno + message.SYN + -1</code>就可以一步解决（boolean类型为true时，本质是为1，反正false为0）<br />
因此receive的实现如下</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">TCPReceiver</span><span class="token double-colon punctuation">::</span><span class="token function">receive</span><span class="token punctuation">(</span> TCPSenderMessage message<span class="token punctuation">,</span> Reassembler<span class="token operator">&amp;</span> reassembler<span class="token punctuation">,</span> Writer<span class="token operator">&amp;</span> inbound_stream <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>after_handshaking <span class="token punctuation">)</span> <span class="token comment">// no handshaking</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> message<span class="token punctuation">.</span>SYN <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      after_handshaking <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// after handshaking</span>
      zero_point <span class="token operator">=</span> Wrap32 <span class="token punctuation">&#123;</span> message<span class="token punctuation">.</span>seqno <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">uint64_t</span> checkpoint <span class="token operator">=</span> inbound_stream<span class="token punctuation">.</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// first unassembled index</span>
  <span class="token keyword">uint64_t</span> absolute_seqno <span class="token operator">=</span> <span class="token function">Wrap32</span><span class="token punctuation">(</span> message<span class="token punctuation">.</span>seqno <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span> zero_point<span class="token punctuation">,</span> checkpoint <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> first_index <span class="token operator">=</span> absolute_seqno <span class="token operator">+</span> message<span class="token punctuation">.</span>SYN <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// since zero, remove SYN if exist</span>
  reassembler<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span> first_index<span class="token punctuation">,</span> message<span class="token punctuation">.</span>payload<span class="token punctuation">,</span> message<span class="token punctuation">.</span>FIN<span class="token punctuation">,</span> inbound_stream <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="322-send"><a class="markdownIt-Anchor" href="#322-send"></a> 3.2.2 send</h3>
<p>TCP的接受端要向发送端反馈信息，实验的要求比实际情况是简化了的（不用为接受端的包生成随机初始序号），包括确认信息ackno和用于流量控制的窗口大小信息（rwnd, receiver window）window_size</p>
<ul>
<li>ackno：期望收到的下一个字节的序号（相对序号）</li>
<li>window_size：结合lab1和下图，可以看出window_size就是重组器用于排序的存储空间(storage)，可直接通过writer的available_capacity函数获得</li>
</ul>
<img src="/2023/05/31/computer-Network/CS144/a77e7e0ef331e6368c1bc5ff65569cd9.png" class="">
<p>因此send函数的实现如下：<br />
根据文档描述</p>
<blockquote>
<p>in TCP the SYN (beginning-of-stream) and FIN (end-of-stream) control flags are assigned sequence numbers. Each of these occupies one sequence number. (The sequence number occupied by the SYN flag is the ISN.) Each byte of data in the stream also occupies one sequence number.</p>
</blockquote>
<p>如果接受方收到一个message后流结束了(<code>inbound_stream.is_closed()</code> )则说明该流包含FIN，而标志流结束的FIN还会占用一个序列号，所以此时next_expected_seq需要额外再加1</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">TCPReceiverMessage <span class="token class-name">TCPReceiver</span><span class="token double-colon punctuation">::</span><span class="token function">send</span><span class="token punctuation">(</span> <span class="token keyword">const</span> Writer<span class="token operator">&amp;</span> inbound_stream <span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Your code here.</span>
  TCPReceiverMessage msg<span class="token punctuation">;</span>

  <span class="token comment">/*window_size*/</span>
  <span class="token keyword">uint64_t</span> _available_capacity <span class="token operator">=</span> inbound_stream<span class="token punctuation">.</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  msg<span class="token punctuation">.</span>window_size <span class="token operator">=</span> _available_capacity <span class="token operator">></span> UINT16_MAX <span class="token operator">?</span> UINT16_MAX <span class="token operator">:</span> _available_capacity<span class="token punctuation">;</span>

  <span class="token comment">/*ackno*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>after_handshaking <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    msg<span class="token punctuation">.</span>ackno <span class="token operator">=</span> nullopt<span class="token punctuation">;</span> <span class="token comment">// or &#123;&#125; instead</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">uint64_t</span> next_expected_seq <span class="token operator">=</span> inbound_stream<span class="token punctuation">.</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> inbound_stream<span class="token punctuation">.</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// FIN</span>
      <span class="token operator">++</span>next_expected_seq<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>ackno <span class="token operator">=</span> zero_point <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> next_expected_seq <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// wrap</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="33-result"><a class="markdownIt-Anchor" href="#33-result"></a> 3.3. result</h2>
<img src="/2023/05/31/computer-Network/CS144/4ca2b48b339cd80c6d86e1d24d06da1e.png" class="">
<h1 id="4-lab3-the-tcp-sender"><a class="markdownIt-Anchor" href="#4-lab3-the-tcp-sender"></a> 4. lab3 the TCP sender</h1>
<img src="/2023/05/31/computer-Network/CS144/0c490d98cf317a4773f7a4451f66c0c0.png" class="">
<p>下面讲讲实现过程中遇到的难点和debug过程</p>
<h2 id="41tcp_senderhh"><a class="markdownIt-Anchor" href="#41tcp_senderhh"></a> 4.1tcp_sender.hh</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/Elite-zx/CS144/blob/main/src/tcp_sender.hh">tcp_sender.hh</a><br />
在<code>tcp_sender.hh</code>实现一个Timer类，注意rest_time使用int64_t类型， 我一开始顺手写成uint64_t导致超时无法触发，debug后才发现。</p>
<p>发送端的payload类型是Buffer, 这是一个包含智能指针的类，这使得发送端缓存已发生但未确认的seg时，只是增加了对同一块内存的引用计数，而不会真的复制payload。这体现了文档中的这样一句话</p>
<blockquote>
<p>This turns out not to be very wasteful because the TCPSenderMessage’s payload is stored as a reference-counted read-only string (a Buffer object). So don’t  worry about it—it’s not actually copying the payload data.</p>
</blockquote>
<p>当你复制<code>TCPSenderMessage</code>对象时，<code>Buffer</code>对象的复制也将涉及到<code>std::shared_ptr&lt;std::string&gt;</code>的复制。在复制<code>std::shared_ptr</code>时，它不会创建一个新的字符串对象，而是创建一个新的智能指针，指向同一个字符串对象，并将该对象的引用计数加1。这就意味着新的<code>TCPSenderMessage</code>对象和原始的<code>TCPSenderMessage</code>对象共享相同的<code>payload</code>。当最后一个指向该字符串对象的<code>std::shared_ptr</code>被销毁（该seg被确认因此缓存被清除）时，<code>std::shared_ptr</code>将自动删除其管理的字符串对象，从而防止内存泄漏。</p>
<img src="/2023/05/31/computer-Network/CS144/f7c52fe07e3728ab4b4d5b84f335d6ce.png" class="">
<h2 id="42-tcp_sendercc"><a class="markdownIt-Anchor" href="#42-tcp_sendercc"></a> 4.2. tcp_sender.cc</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/Elite-zx/CS144/blob/main/src/tcp_sender.cc">tcp_sender.cc</a></p>
<h3 id="421-设置fin位"><a class="markdownIt-Anchor" href="#421-设置fin位"></a> 4.2.1 设置FIN位</h3>
<p>发送方向接受方发送FIN被置true的包以标志流的结尾(marked with the SYN flag at the beginning of the stream, and FIN flag at the end.)</p>
<p>包含的FIN的包有两种情况</p>
<ul>
<li>一个数据包，其中FIN flag被置为true<br />
即<strong>有可用空间时在段中搭载 FIN</strong>（Piggyback FIN in segment when space is available）<br />
当outbound_stream中的数据均打包到data_seg中，stream is finished, 而接受窗口应该至少有一个空余字节(space is available))，此时要将最后一个数据包的FIN置1 (这里要多占一个字节）<br />
看下图的测试用例，窗口的大小为8,而剩下的数据大小仅为4 bytes, 因此足以让最后一个数据包设置FIN位</li>
</ul>
<img src="/2023/05/31/computer-Network/CS144/d9d31cacab2e25fe8ec17789df9afc85.png" class="">
<ul>
<li>单独的一个FIN flag 包，payload为0<br />
这种情况出现中，流传输完毕后，接受窗口被填满，此时<strong>没有多余空间为最后一个数据包添加FIN位</strong>，因此发送方在接受方的接受窗口有空余时，再发送一个单独的FIN包<br />
看下图的测试用例，数据包正好占用了7个空间，填满了当前窗口 rwnd = 0 ，因此此时不能设置FIN位。在后续收到新的rwnd= 1的后，接受方知道有空余位置了，发送一个单独的FIN包</li>
</ul>
<img src="/2023/05/31/computer-Network/CS144/780242ece281a0ca811c9b4811ea69dc.png" class="">
<h3 id="422-debug"><a class="markdownIt-Anchor" href="#422-debug"></a> 4.2.2 debug</h3>
<p>遇到了一个很奇怪的测试用例&quot;SYN+FIN&quot;，这个用例要求我们同时设置SYN位和FIN位。首先发送方收到来自接受方的一个握手之前的ackno为nullopt的数据包(可能原因：网络延迟，旧链接断开之前的包在新链接建立之前达到)，接着发送方流向reader的流就关闭了，没有传出任何数据就关闭了。此时要求我们设置SYN+FIN的flag包，不包含任何数据负载。我只能在设置syn时检测流是否关闭从而通过这个测试用例，因为确实不知道什么情况下会有这样的包。</p>
<img src="/2023/05/31/computer-Network/CS144/fe364c4d14e753567f3b654f7ea523e5.png" class="">
<h3 id="423-result"><a class="markdownIt-Anchor" href="#423-result"></a> 4.2.3 result</h3>
<img src="/2023/05/31/computer-Network/CS144/f9b40071ddfcc3d470d363c88538b467.png" class="">
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://elite-zx.github.io">Elite-X</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://elite-zx.github.io/2023/05/31/computer-Network/CS144/">https://elite-zx.github.io/2023/05/31/computer-Network/CS144/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Foundation/">Foundation</a></div><div class="post_share"><div class="social-share" data-image="/img/cat.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/05/24/computer-Network/socket-programming/" title="[计算机网络自顶向下] Socket Programming Assignment + Miscellaneous Labs "><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">[计算机网络自顶向下] Socket Programming Assignment + Miscellaneous Labs </div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/03/06/CSAPP-Lab/CSAPP-LAB/" title="CMU CS15213: CSAPP"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-06</div><div class="title">CMU CS15213: CSAPP</div></div></a></div><div><a href="/2023/02/04/CSAPP-Lab/assembly/" title="汇编语言【王爽】实验流程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-04</div><div class="title">汇编语言【王爽】实验流程</div></div></a></div><div><a href="/2023/05/18/computer-Network/Wireshark-Lab/" title="[计算机网络自顶向下] Wireshake Lab --- HTTP DNS UDP TCP"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-18</div><div class="title">[计算机网络自顶向下] Wireshake Lab --- HTTP DNS UDP TCP</div></div></a></div><div><a href="/2023/05/24/computer-Network/socket-programming/" title="[计算机网络自顶向下] Socket Programming Assignment + Miscellaneous Labs "><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-24</div><div class="title">[计算机网络自顶向下] Socket Programming Assignment + Miscellaneous Labs </div></div></a></div><div><a href="/2023/05/06/OS-Learning/HIT-OS-Labs/" title="[HIT-OS]哈工大操作系统实验lab1~8"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-06</div><div class="title">[HIT-OS]哈工大操作系统实验lab1~8</div></div></a></div><div><a href="/2023/05/06/OS-Learning/HIT-OS/" title="[HIT-OS]哈工大操作系统Notes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-06</div><div class="title">[HIT-OS]哈工大操作系统Notes</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-lab0-networking-warmup"><span class="toc-text"> 1.  lab0 networking warmup</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-set-up-gnulinux-on-your-computer"><span class="toc-text"> 1.1. Set up GNU&#x2F;Linux on your computer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-networking-by-hand"><span class="toc-text"> 1.2. Networking by hand</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#121-fetch-a-web-page"><span class="toc-text"> 1.2.1. Fetch a Web page</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#122-send-yourself-an-email"><span class="toc-text"> 1.2.2. Send yourself an email</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#123-listening-and-connecting"><span class="toc-text"> 1.2.3. Listening and connecting</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-writing-a-network-program-using-an-os-stream-socket"><span class="toc-text"> 1.3. Writing a network program using an OS stream socket</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#131-lets-get-startedfetching-and-building-the-starter-code"><span class="toc-text"> 1.3.1. Let’s get started—fetching and building the starter code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#132-modern-c-mostly-safe-but-still-fast-and-low-level"><span class="toc-text"> 1.3.2. Modern C++: mostly safe but still fast and low-level</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#133-reading-the-minnow-support-code"><span class="toc-text"> 1.3.3. Reading the Minnow support code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#134-writing-webget"><span class="toc-text"> 1.3.4. Writing webget</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-an-in-memory-reliable-byte-stream"><span class="toc-text"> 1.4. An in-memory reliable byte stream</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#141-target"><span class="toc-text"> 1.4.1. target</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#142-source-code"><span class="toc-text"> 1.4.2. source code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#143-result"><span class="toc-text"> 1.4.3. result</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-lab1-stitching-substrings-into-a-byte-stream"><span class="toc-text"> 2. lab1 stitching substrings into a byte stream</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-target"><span class="toc-text"> 2.1. target</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-analyze"><span class="toc-text"> 2.2. analyze</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-source-code"><span class="toc-text"> 2.3. source code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#231-reassemblerhh"><span class="toc-text"> 2.3.1 reassembler.hh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#232-reassemblercc"><span class="toc-text"> 2.3.2 reassembler.cc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-result"><span class="toc-text"> 2.4. result</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-lab2-the-tcp-receiver"><span class="toc-text"> 3. lab2 the TCP receiver</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#31-translating-between-64-bit-indexes-and-32-bit-seqnos"><span class="toc-text"> 3.1. Translating between 64-bit indexes and 32-bit seqnos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#311-wrapabsolute-seqno-to-seqno"><span class="toc-text"> 3.1.1 wrap—absolute seqno to seqno</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#312-unwrap-seqno-to-absolute-seqno"><span class="toc-text"> 3.1.2 unwrap— seqno to absolute seqno</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#32-implementing-the-tcp-receiver"><span class="toc-text"> 3.2. Implementing the TCP receiver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#321-receive"><span class="toc-text"> 3.2.1 receive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#322-send"><span class="toc-text"> 3.2.2 send</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#33-result"><span class="toc-text"> 3.3. result</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-lab3-the-tcp-sender"><span class="toc-text"> 4. lab3 the TCP sender</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#41tcp_senderhh"><span class="toc-text"> 4.1tcp_sender.hh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#42-tcp_sendercc"><span class="toc-text"> 4.2. tcp_sender.cc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#421-%E8%AE%BE%E7%BD%AEfin%E4%BD%8D"><span class="toc-text"> 4.2.1 设置FIN位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#422-debug"><span class="toc-text"> 4.2.2 debug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#423-result"><span class="toc-text"> 4.2.3 result</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By Elite-X</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://unpkg.com/mathjax/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'e81d3036a2dbceba447b',
      clientSecret: '4f031eb85eeebde1069ca0424a9660a810619614',
      repo: 'Elite-zx.github.io',
      owner: 'Elite-zx',
      admin: ['Elite-zx'],
      id: 'c27036a67759fd015986363069f4dd29',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://unpkg.com/gitalk/dist/gitalk.css')
    getScript('https://unpkg.com/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !true) {
  if (true) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script src="https://unpkg.com/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1s');
    arr[i].setAttribute('data-wow-delay', '0.5s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></body></html>